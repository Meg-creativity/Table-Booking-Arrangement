<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁÅ´ÈçãÂ∫óÁèæÂ†¥Ë™øÂ∫¶Á≥ªÁµ±</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        // Áî±ÊñºÊòØÂú® HTML Áí∞Â¢ÉÔºåÊàëÂÄëÊâãÂãïÂÆöÁæ© Lucide ÂúñÁ§∫ÁµÑ‰ª∂
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        const INITIAL_TABLES = [
            { id: '1', capacity: 4 }, { id: '2', capacity: 4 },
            { id: '3', capacity: 4 }, { id: '4', capacity: 4 },
            { id: '5', capacity: 4 }, { id: '81', capacity: 2 },
            { id: '85', capacity: 2 },
        ];

        const DINING_DURATION = 90;
        const CLEANING_BUFFER = 10;

        const App = () => {
            const [tables, setTables] = useState(INITIAL_TABLES.map(t => ({ ...t, status: 'idle', currentGuest: null })));
            const getTodayStr = () => new Date().toISOString().split('T')[0];
            
            // ‰ΩøÁî® localStorage ËÆìË≥áÊñôÂú®ÈáçÊñ∞Êï¥ÁêÜÂæå‰∏çÊúÉÊ∂àÂ§± (GitHub ÁâàÂøÖÂÇô)
            const [reservations, setReservations] = useState(() => {
                const saved = localStorage.getItem('hotpot_resv');
                return saved ? JSON.parse(saved) : [
                    { id: 1, date: getTodayStr(), time: '17:30', endTime: '19:00', nextAvailable: '19:10', name: 'ÁéãÂ∞èÂßê', count: 4, tableId: '1' }
                ];
            });

            const [currentTime, setCurrentTime] = useState(new Date());
            const [view, setView] = useState('tables'); 
            const [selectedDate, setSelectedDate] = useState(getTodayStr());
            const [isCheckInModalOpen, setIsCheckInModalOpen] = useState(false);
            const [isResvModalOpen, setIsResvModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [selectedTable, setSelectedTable] = useState(null);
            const [resvForm, setResvForm] = useState({ date: getTodayStr(), time: '11:00', name: '', count: 1, tableId: '' });

            useEffect(() => {
                localStorage.setItem('hotpot_resv', JSON.stringify(reservations));
            }, [reservations]);

            useEffect(() => {
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            const formatTime = (date) => date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false });
            const timeToMinutes = (timeStr) => {
                const [h, m] = timeStr.split(':').map(Number);
                return h * 60 + m;
            };
            const minutesToTime = (totalMinutes) => {
                const h = Math.floor(totalMinutes / 60);
                const m = totalMinutes % 60;
                return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
            };

            const getNextResvToday = (tableId) => {
                const todayStr = getTodayStr();
                const nowMin = timeToMinutes(formatTime(currentTime));
                return reservations
                    .filter(r => r.tableId === tableId && r.date === todayStr && timeToMinutes(r.time) > nowMin)
                    .sort((a, b) => timeToMinutes(a.time) - timeToMinutes(b.time))[0];
            };

            const canCheckInNow = (tableId) => {
                const nextResv = getNextResvToday(tableId);
                if (!nextResv) return { can: true };
                const nowMin = timeToMinutes(formatTime(currentTime));
                const limitMin = timeToMinutes(nextResv.time) - CLEANING_BUFFER;
                const availableMins = limitMin - nowMin;
                if (availableMins < DINING_DURATION) {
                    return { can: false, reason: `È†êÁ¥Ñ‰øùÁïô‰∏≠ (${nextResv.time})`, availableUntil: minutesToTime(limitMin), resvTime: nextResv.time };
                }
                return { can: true, availableUntil: minutesToTime(limitMin), resvTime: nextResv.time };
            };

            const checkTotalConflict = (tableId, dateStr, startTimeStr, excludeId = null) => {
                const startMin = timeToMinutes(startTimeStr);
                const endMin = startMin + DINING_DURATION + CLEANING_BUFFER;
                const resvConflict = reservations.some(res => {
                    if (res.tableId !== tableId || res.date !== dateStr || res.id === excludeId) return false;
                    const resStart = timeToMinutes(res.time);
                    const resEnd = timeToMinutes(res.nextAvailable);
                    return (startMin < resEnd && resStart < endMin);
                });
                if (resvConflict) return "Â∑≤È†êÁ¥Ñ";
                return null;
            };

            const handleCheckIn = (tableId, name = "ÁèæÂ†¥ÂÆ¢‰∫∫") => {
                const startTime = new Date();
                const endTime = new Date(startTime.getTime() + DINING_DURATION * 60000);
                setTables(prev => prev.map(t => t.id === tableId ? { ...t, status: 'occupied', currentGuest: { name, startTime, endTime } } : t));
            };

            const handleCheckOut = (tableId) => {
                setTables(prev => prev.map(t => t.id === tableId ? { ...t, status: 'idle', currentGuest: null } : t));
            };

            const handleSaveResv = (e) => {
                e.preventDefault();
                const [h, m] = resvForm.time.split(':').map(Number);
                const start = new Date(); start.setHours(h, m, 0);
                const end = new Date(start.getTime() + DINING_DURATION * 60000);
                const next = new Date(end.getTime() + CLEANING_BUFFER * 60000);
                const times = { endTime: formatTime(end), nextAvailable: formatTime(next) };

                if (editingId) {
                    setReservations(prev => prev.map(r => r.id === editingId ? { ...resvForm, ...times, id: editingId } : r).sort((a,b) => a.time.localeCompare(b.time)));
                } else {
                    setReservations(prev => [...prev, { ...resvForm, ...times, id: Date.now() }].sort((a,b) => a.time.localeCompare(b.time)));
                }
                closeModal();
            };

            const closeModal = () => { setIsResvModalOpen(false); setEditingId(null); setResvForm({ date: getTodayStr(), time: '11:00', name: '', count: 1, tableId: '' }); };

            const timeOptions = useMemo(() => {
                const opts = [];
                for (let h = 11; h <= 20; h++) {
                    for (let m = 0; m < 60; m += 10) {
                        const t = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
                        if ((t >= '11:00' && t <= '13:30') || (t >= '17:00' && t <= '19:50')) opts.push(t);
                    }
                }
                return opts;
            }, []);

            return (
                <div className="min-h-screen bg-slate-50 text-slate-900 pb-10">
                    <nav className="bg-white border-b px-6 py-4 flex justify-between items-center sticky top-0 z-10 shadow-sm">
                        <div className="flex items-center gap-3">
                            <div className="bg-orange-500 p-2 rounded-lg text-white"><Icon name="users" /></div>
                            <div>
                                <h1 className="text-xl font-bold">ÁÅ´ÈçãÂ∫óË™øÂ∫¶Á≥ªÁµ±</h1>
                                <p className="text-xs text-slate-500">{formatTime(currentTime)} | üü¢ ÁáüÊ•≠‰∏≠</p>
                            </div>
                        </div>
                        <div className="flex bg-slate-100 p-1 rounded-xl">
                            <button onClick={() => setView('tables')} className={`px-4 py-2 rounded-lg text-sm font-bold ${view === 'tables' ? 'bg-white shadow-sm text-orange-600' : 'text-slate-500'}`}>Ê°å‰Ωç</button>
                            <button onClick={() => setView('reservations')} className={`px-4 py-2 rounded-lg text-sm font-bold ${view === 'reservations' ? 'bg-white shadow-sm text-orange-600' : 'text-slate-500'}`}>È†êÁ¥Ñ</button>
                        </div>
                    </nav>

                    <main className="p-6 max-w-7xl mx-auto">
                        {view === 'tables' ? (
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                {tables.map(table => {
                                    const isOccupied = table.status === 'occupied';
                                    const status = canCheckInNow(table.id);
                                    const remaining = isOccupied ? Math.round((table.currentGuest.endTime - currentTime) / 60000) : null;
                                    return (
                                        <div key={table.id} className={`border-2 rounded-3xl p-5 shadow-sm flex flex-col justify-between h-60 transition-all ${isOccupied ? 'bg-green-100 border-green-500' : (!status.can ? 'bg-slate-200 border-slate-300' : 'bg-white')}`}>
                                            <div className="flex justify-between items-start">
                                                <span className="text-3xl font-black">{table.id} <span className="text-xs">Ê°å</span></span>
                                                {status.availableUntil && !isOccupied && <div className="text-[10px] font-bold text-orange-600 bg-white px-2 py-0.5 rounded border">ÈôêÁî®Ëá≥ {status.availableUntil}</div>}
                                            </div>
                                            {isOccupied ? (
                                                <div>
                                                    <div className="font-bold text-lg">{table.currentGuest.name}</div>
                                                    <div className="flex items-center justify-between mt-4">
                                                        <span className="text-xs font-bold">Ââ©È§ò {remaining} ÂàÜ</span>
                                                        <button onClick={() => handleCheckOut(table.id)} className="bg-white px-3 py-1 rounded-xl border text-sm font-bold">ÁµêÂ∏≥</button>
                                                    </div>
                                                </div>
                                            ) : (
                                                status.can ? 
                                                <button onClick={() => { setSelectedTable(table); setIsCheckInModalOpen(true); }} className="w-full py-3 rounded-2xl bg-orange-500 text-white font-black shadow-lg">ÁèæÂ†¥Â∏∂‰Ωç</button> :
                                                <div className="text-center text-slate-400 font-bold"><Icon name="ban" className="mx-auto mb-1" size={20} />{status.reason}</div>
                                            )}
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="bg-white rounded-3xl shadow-sm border overflow-hidden">
                                <div className="p-6 border-b flex justify-between items-center">
                                    <h2 className="font-bold">È†êÁ¥ÑÊ∏ÖÂñÆ ({selectedDate})</h2>
                                    <button onClick={() => setIsResvModalOpen(true)} className="bg-orange-500 text-white px-4 py-2 rounded-xl text-sm font-bold">+ Êñ∞Â¢û</button>
                                </div>
                                <table className="w-full text-left">
                                    <thead className="bg-slate-50 text-[10px] font-black uppercase">
                                        <tr><th className="px-6 py-4">ÊôÇÈñì</th><th className="px-6 py-4">Ê°åËôü</th><th className="px-6 py-4">ÂßìÂêç</th><th className="px-6 py-4 text-right">Êìç‰Ωú</th></tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {reservations.filter(r => r.date === selectedDate).map(res => (
                                            <tr key={res.id}>
                                                <td className="px-6 py-4 font-bold">{res.time}</td>
                                                <td className="px-6 py-4 font-black">{res.tableId}</td>
                                                <td className="px-6 py-4">{res.name}</td>
                                                <td className="px-6 py-4 text-right">
                                                    <button onClick={() => { setEditingId(res.id); setResvForm(res); setIsResvModalOpen(true); }} className="text-blue-500 mr-2"><Icon name="edit-3" size={16}/></button>
                                                    <button onClick={() => setReservations(prev => prev.filter(p => p.id !== res.id))} className="text-red-400"><Icon name="trash-2" size={16}/></button>
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </main>

                    {/* È†êÁ¥Ñ Modal */}
                    {isResvModalOpen && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-[2rem] w-full max-w-md p-8">
                                <h3 className="text-xl font-bold mb-6">{editingId ? '‰øÆÊ≠£È†êÁ¥Ñ' : 'Êñ∞Â¢ûÈ†êÁ¥Ñ'}</h3>
                                <div className="space-y-4">
                                    <input type="date" className="w-full border p-3 rounded-xl" value={resvForm.date} onChange={e => setResvForm({...resvForm, date: e.target.value})} />
                                    <select className="w-full border p-3 rounded-xl" value={resvForm.time} onChange={e => setResvForm({...resvForm, time: e.target.value})}>
                                        {timeOptions.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                    <input placeholder="È°ßÂÆ¢ÂßìÂêç" className="w-full border p-3 rounded-xl" value={resvForm.name} onChange={e => setResvForm({...resvForm, name: e.target.value})} />
                                    <select className="w-full border p-3 rounded-xl" value={resvForm.tableId} onChange={e => setResvForm({...resvForm, tableId: e.target.value})}>
                                        <option value="">ÈÅ∏ÊìáÊ°åËôü</option>
                                        {INITIAL_TABLES.map(t => <option key={t.id} value={t.id} disabled={!!checkTotalConflict(t.id, resvForm.date, resvForm.time, editingId)}>{t.id} Ê°å</option>)}
                                    </select>
                                    <div className="flex gap-2">
                                        <button onClick={closeModal} className="flex-1 py-3 font-bold text-slate-400">ÂèñÊ∂à</button>
                                        <button onClick={handleSaveResv} className="flex-1 py-3 bg-orange-500 text-white font-bold rounded-xl">ÂÑ≤Â≠ò</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Â∏∂‰Ωç Modal */}
                    {isCheckInModalOpen && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-[2rem] w-full max-w-sm p-8">
                                <h3 className="text-xl font-bold mb-4">Â∏∂‰ΩçÂÖ•Â∫ß - {selectedTable?.id}Ê°å</h3>
                                <input id="nameIn" placeholder="ÂÆ¢‰∫∫Á®±Âëº" className="w-full border p-3 rounded-xl mb-6" />
                                <div className="flex gap-2">
                                    <button onClick={() => setIsCheckInModalOpen(false)} className="flex-1 py-3 font-bold">ÂèñÊ∂à</button>
                                    <button onClick={() => { handleCheckIn(selectedTable.id, document.getElementById('nameIn').value || "ÁèæÂ†¥ÂÆ¢"); setIsCheckInModalOpen(false); }} className="flex-1 py-3 bg-slate-800 text-white font-bold rounded-xl">Á¢∫Ë™ç</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
